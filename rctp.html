<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RCTP METAR è‡ªå‹•æ›´æ–°è¦–è¦ºåŒ–</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: white; }
    #canvas { width: 300px; height: 300px; margin: 0 auto; border: 1px solid #ccc; border-radius: 50%; position: relative; }
    #windArrow {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 150px solid red;
      position: absolute;
      top: 0;
      left: 146px;
      transform-origin: bottom center;
    }
    .info { margin-top: 20px; font-size: 18px; }
    .red { color: red; }
    .icon { width: 50px; vertical-align: middle; }
    #runway {
      position: absolute;
      width: 15px;
      height: 180px;
      background: black;
      top: 60px;
      left: 145px;
      transform-origin: center;
    }
    .angle-label {
      position: absolute;
      font-size: 14px;
      color: #555;
      transform: translate(-50%, -50%);
    }
    .compass-label {
      position: absolute;
      font-size: 12px;
      font-weight: bold;
      color: #222;
      transform: translate(-50%, -50%);
    }
    .explanation {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ccc;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      font-size: 16px;
      line-height: 1.6;
    }
    .controls {
      margin: 20px 0;
    }
    .controls select {
      font-size: 16px;
      padding: 5px 10px;
      margin: 0 10px;
    }
    .controls button {
      font-size: 16px;
      padding: 5px 15px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .controls button:hover {
      background-color: #0056b3;
    }
    .update-info {
      margin: 10px 0;
      font-size: 14px;
      color: #666;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: red;
      margin: 10px 0;
    }
    .raw-metar {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      margin: 20px auto;
      max-width: 800px;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h2>æ©Ÿå ´ METAR è‡ªå‹•æ›´æ–°è¦–è¦ºåŒ–</h2>
  
  <div class="controls">
    <label for="airportSelect">é¸æ“‡æ©Ÿå ´ï¼š</label>
    <select id="airportSelect">
      <option value="RCTP">RCTP - æ¡ƒåœ’åœ‹éš›æ©Ÿå ´</option>
      <option value="RCSS">RCSS - æ¾å±±æ©Ÿå ´</option>
      <option value="RCKH">RCKH - é«˜é›„åœ‹éš›æ©Ÿå ´</option>
      <option value="RCFN">RCFN - å°å—æ©Ÿå ´</option>
      <option value="RCMQ">RCMQ - å°ä¸­æ©Ÿå ´</option>
    </select>
    <button onclick="fetchMETAR()">ç«‹å³æ›´æ–°</button>
    <label>
      <input type="checkbox" id="autoUpdate" checked> è‡ªå‹•æ›´æ–°ï¼ˆæ¯5åˆ†é˜ï¼‰
    </label>
  </div>

  <div class="update-info" id="updateInfo"></div>
  <div class="error" id="errorMessage"></div>

  <div class="info" id="weatherInfo"></div>
  
  <div class="raw-metar" id="rawMetar" style="display: none;"></div>

  <div id="canvas">
    <div id="runway"></div>
    <div id="windArrow"></div>
  </div>

  <div class="explanation">
    <h3>è³‡è¨Šèªªæ˜ï¼š</h3>
    <ul>
      <li><strong>æ©Ÿå ´ ICAO ä»£ç¢¼</strong>ï¼šé¡¯ç¤ºå ±å‘Šæ‰€å±¬æ©Ÿå ´ä»£ç¢¼ï¼Œä¾‹å¦‚ RCTPã€‚</li>
      <li><strong>å¤©æ°£åœ–ç¤º</strong>ï¼šâ˜€ï¸ï¼ˆæ™´å¤©ï¼‰ã€ğŸŒ§ï¸ï¼ˆé™é›¨ï¼‰ã€ğŸŒ«ï¸ï¼ˆéœ§ï¼‰ã€â›ˆï¸ï¼ˆé›·é›¨ï¼‰ã€â“ï¼ˆä¸æ˜å¤©æ°£ï¼‰ã€‚</li>
      <li><strong>é£›è¡Œæ¢ä»¶åˆ†é¡</strong>ï¼šä¾æ“šèƒ½è¦‹åº¦èˆ‡é›²åº•é«˜ï¼Œåˆ†ç‚º VFRã€MVFRã€IFRã€LIFRã€‚</li>
      <li><strong>æ°£è±¡æ•¸æ“š</strong>ï¼šé¡¯ç¤ºæº«åº¦ã€éœ²é»ã€èƒ½è¦‹åº¦ã€é›²åº•é«˜åº¦ã€æ°£å£“ã€‚</li>
      <li><strong>æ¨è–¦è·‘é“è™Ÿç¢¼</strong>ï¼šä¾æ“šé¢¨å‘èˆ‡è·‘é“è§’åº¦æ¨è–¦æœ€ä½³ä½¿ç”¨è·‘é“ã€‚</li>
      <li><strong>é¢¨èˆ‡è·‘é“è§’åº¦å·®</strong>ï¼šæŒ‡å‡ºé¢¨å‘èˆ‡è·‘é“æ–¹å‘çš„å¤¾è§’ï¼Œå¹«åŠ©åˆ¤æ–·æ˜¯å¦ç‚ºé †é¢¨ã€å´é¢¨ã€‚</li>
    </ul>
  </div>

  <script>
    // åˆå§‹åŒ–ç¾…ç›¤æ¨™ç±¤
    const canvas = document.getElementById("canvas");
    for (let i = 0; i < 360; i += 30) {
      const label = document.createElement("div");
      label.className = "angle-label";
      const radius = 140;
      const rad = (i - 90) * Math.PI / 180;
      label.style.left = 150 + radius * Math.cos(rad) + "px";
      label.style.top = 150 + radius * Math.sin(rad) + "px";
      label.innerText = i;
      canvas.appendChild(label);
    }
    
    const directions = [
      { label: 'N', deg: 0 },
      { label: 'E', deg: 90 },
      { label: 'S', deg: 180 },
      { label: 'W', deg: 270 }
    ];
    directions.forEach(d => {
      const dirLabel = document.createElement("div");
      dirLabel.className = "compass-label";
      const rad = (d.deg - 90) * Math.PI / 180;
      const radius = 120;
      dirLabel.style.left = 150 + radius * Math.cos(rad) + "px";
      dirLabel.style.top = 150 + radius * Math.sin(rad) + "px";
      dirLabel.innerText = d.label;
      canvas.appendChild(dirLabel);
    });

    // è·‘é“æ–¹å‘å°ç…§è¡¨
    const runwayMap = {
      RCTP: [50, 230],    // 05/23
      RCSS: [100, 280],   // 10/28
      RCKH: [90, 270],    // 09/27
      RCFN: [90, 270],    // 09/27 (å¯¦éš›æ˜¯ 11/29ï¼Œé€™è£¡ç°¡åŒ–)
      RCMQ: [40, 220]     // 04/22
    };

    let autoUpdateInterval;

    // å¾ AVWX API å–å¾— METAR
    async function fetchMETAR() {
      const icao = document.getElementById('airportSelect').value;
      const updateInfo = document.getElementById('updateInfo');
      const errorMessage = document.getElementById('errorMessage');
      
      updateInfo.innerHTML = 'æ­£åœ¨ç²å–æœ€æ–°å¤©æ°£è³‡æ–™... <span class="loading"></span>';
      errorMessage.textContent = '';
      
      try {
        // ä½¿ç”¨ CORS proxy ä¾†é¿å… CORS å•é¡Œ
        const proxyUrl = 'https://corsproxy.io/?';
        const apiUrl = `https://avwx.rest/api/metar/${icao}`;
        
        const response = await fetch(proxyUrl + encodeURIComponent(apiUrl), {
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™');
        }
        
        const data = await response.json();
        
        if (data.raw) {
          document.getElementById('rawMetar').textContent = `åŸå§‹ METAR: ${data.raw}`;
          document.getElementById('rawMetar').style.display = 'block';
          parseMETARData(data);
          updateInfo.innerHTML = `æœ€å¾Œæ›´æ–°æ™‚é–“: ${new Date().toLocaleString('zh-TW')}`;
        } else {
          throw new Error('æ”¶åˆ°çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
        }
      } catch (error) {
        console.error('Error fetching METAR:', error);
        errorMessage.textContent = `éŒ¯èª¤ï¼š${error.message}ã€‚è«‹ç¨å¾Œå†è©¦ã€‚`;
        updateInfo.innerHTML = '';
        
        // æä¾›å‚™ç”¨æ–¹æ¡ˆ
        errorMessage.innerHTML += '<br>æ‚¨ä¹Ÿå¯ä»¥å¾ <a href="https://www.aviationweather.gov/metar" target="_blank">Aviation Weather</a> æ‰‹å‹•å–å¾— METAR è³‡æ–™ã€‚';
      }
    }

    // è§£æ METAR è³‡æ–™ï¼ˆä½¿ç”¨ AVWX API çš„çµæ§‹åŒ–è³‡æ–™ï¼‰
    function parseMETARData(data) {
      const icao = data.station;
      
      // é¢¨å‘é¢¨é€Ÿ
      let dir = 0, speed = 0;
      if (data.wind_direction && data.wind_direction.repr !== 'VRB') {
        dir = parseInt(data.wind_direction.repr);
      }
      if (data.wind_speed) {
        speed = parseInt(data.wind_speed.repr);
      }
      
      // æº«åº¦å’Œéœ²é»
      const temp = data.temperature ? data.temperature.repr + "Â°C" : "N/A";
      const dewpoint = data.dewpoint ? data.dewpoint.repr + "Â°C" : "N/A";
      
      // èƒ½è¦‹åº¦
      let vis = "N/A", visVal = 9999;
      if (data.visibility) {
        visVal = parseInt(data.visibility.repr) * 1609; // è½‰æ›è‹±é‡Œåˆ°å…¬å°º
        vis = (visVal / 1000).toFixed(1) + " km";
      }
      
      // é›²å±¤é«˜åº¦
      let ceil = "N/A", ceilVal = 10000;
      if (data.clouds && data.clouds.length > 0) {
        for (let cloud of data.clouds) {
          if (cloud.type === 'BKN' || cloud.type === 'OVC') {
            ceilVal = parseInt(cloud.altitude) * 100;
            ceil = ceilVal + " ft";
            break;
          }
        }
      }
      
      // æ°£å£“
      const pressure = data.altimeter ? Math.round(data.altimeter.value * 33.864) + " hPa" : "N/A";
      
      // å¤©æ°£ç¾è±¡
      let icon = "â˜€ï¸";
      if (data.wx_codes) {
        const wx = data.wx_codes.join('');
        if (wx.includes('TS')) icon = "â›ˆï¸";
        else if (wx.includes('RA') || wx.includes('SH')) icon = "ğŸŒ§ï¸";
        else if (wx.includes('BR') || wx.includes('FG')) icon = "ğŸŒ«ï¸";
      }
      
      // é£›è¡Œé¡åˆ¥
      let category = data.flight_rules || "VFR";
      
      // æ›´æ–°é¢¨å‘ç®­é ­
      const windArrow = document.getElementById("windArrow");
      const rotation = (dir + 180) % 360;
      windArrow.style.transform = `rotate(${rotation}deg)`;
      
      // æ›´æ–°è·‘é“æ–¹å‘
      const rwy = runwayMap[icao] || [50, 230];
      const rwy1 = rwy[0];
      const rwy2 = rwy[1];
      const runwayHeading = rwy1;
      document.getElementById("runway").style.transform = `rotate(${runwayHeading}deg)`;
      
      // è¨ˆç®—æœ€ä½³è·‘é“
      function angleDiff(a, b) {
        let diff = Math.abs(a - b) % 360;
        return diff > 180 ? 360 - diff : diff;
      }
      const diff1 = angleDiff(dir, rwy1);
      const diff2 = angleDiff(dir, rwy2);
      const bestRwy = diff1 < diff2 ? String(Math.round(rwy1 / 10)).padStart(2, '0') : String(Math.round(rwy2 / 10)).padStart(2, '0');
      const angleToRwy = Math.min(diff1, diff2);
      const windType = angleToRwy <= 30 ? "é †é¢¨" : angleToRwy >= 60 ? "å´é¢¨" : "éƒ¨åˆ†é †é¢¨";
      
      // æ›´æ–°é¡¯ç¤ºè³‡è¨Š
      document.getElementById("weatherInfo").innerHTML = `
        <div><strong>æ©Ÿå ´:</strong> ${icao}</div>
        <div><strong>å¤©æ°£:</strong> ${icon}</div>
        <div><strong>é£›è¡Œé¡åˆ¥:</strong> <span class="${category === 'IFR' || category === 'LIFR' ? 'red' : ''}">${category}</span></div>
        <div><strong>æº«åº¦:</strong> ${temp} / <strong>éœ²é»:</strong> ${dewpoint}</div>
        <div><strong>é¢¨å‘é¢¨é€Ÿ:</strong> ${dir}Â° @ ${speed} kt</div>
        <div><strong>èƒ½è¦‹åº¦:</strong> ${vis}</div>
        <div><strong>é›²åº•é«˜åº¦:</strong> <span class="${ceilVal < 3000 ? 'red' : ''}">${ceil}</span></div>
        <div><strong>æ°£å£“:</strong> ${pressure}</div>
        <div><strong>å»ºè­°è·‘é“:</strong> ${bestRwy}</div>
        <div><strong>é¢¨å‘å¤¾è§’:</strong> ${angleToRwy}Â° â€“ ${windType}</div>
      `;
    }

    // è‡ªå‹•æ›´æ–°æ§åˆ¶
    function toggleAutoUpdate() {
      const checkbox = document.getElementById('autoUpdate');
      if (checkbox.checked) {
        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        fetchMETAR();
        // æ¯5åˆ†é˜æ›´æ–°
        autoUpdateInterval = setInterval(fetchMETAR, 300000);
      } else {
        clearInterval(autoUpdateInterval);
      }
    }

    // ç›£è½è‡ªå‹•æ›´æ–°é–‹é—œ
    document.getElementById('autoUpdate').addEventListener('change', toggleAutoUpdate);

    // ç›£è½æ©Ÿå ´é¸æ“‡è®Šæ›´
    document.getElementById('airportSelect').addEventListener('change', fetchMETAR);

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•ç²å–ä¸€æ¬¡
    window.onload = function() {
      toggleAutoUpdate();
    };
  </script>
</body>
</html>
